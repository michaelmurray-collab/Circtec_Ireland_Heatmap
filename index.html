
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Circtec — Ireland Network (v8b)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  html,body,#map { height:100%; margin:0; }
  .brand { position:absolute; top:0; left:0; right:0; height:46px; background:#0b5cff; color:#fff;
           display:flex; align-items:center; gap:8px; padding:0 12px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
           font-weight:600; z-index:1200; box-shadow:0 2px 8px rgba(0,0,0,.15); }
  #map { position:absolute; top:46px; bottom:0; left:0; right:0; }
  .panel { position:absolute; top:56px; left:8px; z-index:1100; background:#fff; border:1px solid #e9e9e9; border-radius:10px;
           box-shadow:0 2px 12px rgba(0,0,0,.18); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-size:14px;
           width:860px; max-width:calc(100% - 16px); overflow:hidden; }
  .panel-header { display:flex; align-items:center; justify-content:space-between; background:#f7f7f7; border-bottom:1px solid #eee; padding:8px 10px; }
  .panel-toggle { background:#0b5cff; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }
  .panel-body { padding:10px 12px; display:block; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
  .btn { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; }
  .input,.select { padding:6px 8px; border:1px solid #ddd; border-radius:8px; background:#fff; }
  .small { font-size:12px; color:#555; }
  .card { border:1px solid #eee; border-radius:8px; padding:8px; background:#fff; }
  .grid4 { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; width:100%; }
  table.summary { border-collapse:collapse; width:100%; font-size:13px; }
  table.summary th, table.summary td { border:1px solid #e5e5e5; padding:6px 8px; text-align:right; }
  table.summary th:first-child, table.summary td:first-child { text-align:left; }
</style>
</head>
<body>
<div class="brand">Circtec — Ireland Network</div>
<div id="map"></div>

<div class="panel">
  <div class="panel-header">
    <div><b>Controls & Cost Model</b> — <span id="hqBadge" class="small">HQ: initialising…</span></div>
    <button id="togglePanelBtn" class="panel-toggle" aria-expanded="true" aria-controls="panelBody">Hide panel ▲</button>
  </div>
  <div id="panelBody" class="panel-body">
    <div class="row">
      <label><input type="radio" name="view" value="heat" checked> Heat map</label>
      <label><input type="radio" name="view" value="markers"> Marker clusters</label>
      <span class="small">Garages: <span id="count">0</span></span>
    </div>

    <div class="row">
      <select id="countyFilter" class="select"><option value="">All counties</option></select>
      <input id="searchBox" class="input" type="search" placeholder="Search name/address…" style="flex:1; min-width:160px">
      <input id="withinKm" class="input" type="number" min="0" step="1" placeholder="Within (km)" style="width:120px">
      <button id="clearFilters" class="btn">Clear</button>
      <button id="exportCsvBtn" class="btn">Export CSV</button>
    </div>

    <hr>
    <div><b>HQ & Rings</b></div>
    <div class="row">
      <input id="hqAddress" class="input" type="text" value="Donore Road Industrial Estate, Donore Rd, Rathmullan, Drogheda, Co. Louth, A92 T851, Ireland" style="flex:1; min-width:260px">
      <button id="geocodeHqBtn" class="btn">Try Geocode</button>
      <button id="clickHqBtn" class="btn">Set HQ by map click</button>
      <input id="hqLat" class="input" type="number" step="0.000001" placeholder="HQ lat" style="width:140px">
      <input id="hqLon" class="input" type="number" step="0.000001" placeholder="HQ lon" style="width:140px">
      <button id="setHqBtn" class="btn">Set lat/lon</button>
    </div>
    <div class="row">
      <div class="grid4">
        <div class="card"><div>Ring 1 (km)</div><input id="ring1km" class="input" type="number" value="50"></div>
        <div class="card"><div>Ring 2 (km)</div><input id="ring2km" class="input" type="number" value="100"></div>
        <div class="card"><div>Ring 3 (km)</div><input id="ring3km" class="input" type="number" value="150"></div>
        <div class="card"><label><input type="checkbox" id="toggleRings" checked> Show rings</label><br><button id="applyRingsBtn" class="btn" style="margin-top:4px">Apply</button><button id="zoomRingsBtn" class="btn" style="margin-top:4px">Zoom</button></div>
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="card" style="flex:1">
        <b>Cost inputs</b>
        <div class="grid4" style="margin-top:6px">
          <div><div>Fuel €/km</div><input id="fuelPerKm" class="input" type="number" step="0.01" value="0.46"></div>
          <div><div>Fixed €/km</div><input id="fixedPerKm" class="input" type="number" step="0.01" value="0.84"></div>
          <div><div>Per-stop €/pickup</div><input id="perStop" class="input" type="number" step="1" value="0"></div>
          <div><div>Pickups/site/year</div><input id="pickupsPerYear" class="input" type="number" step="1" value="1"></div>
        </div>
      </div>
      <div class="card" style="flex:1">
        <b>Ring cost (quick)</b>
        <div class="row" style="margin-top:6px">
          <label>Ring km <input id="ringQueryKm" class="input" type="number" value="100" style="width:90px"></label>
          <label><input type="radio" name="ringMode" value="avg" checked> Band average</label>
          <label><input type="radio" name="ringMode" value="edge"> Ring edge</label>
          <button id="calcRingCost" class="btn">Calculate</button>
        </div>
        <div id="ringCostOut" class="small" style="margin-top:6px"></div>
      </div>
    </div>

       <div class="row">
      <div class="card" style="width:100%">
        <b>Collection Cost Summary</b>
        <table class="summary" id="costTable" style="margin-top:6px">
          <thead>
            <tr>
              <th>Band</th>
              <th>Sites</th>
              <th>Avg dist (km)</th>
              <th>€/trip/site (return)</th>
              <th>€/t (one way)</th>
              <th>€/year (band)</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>0–R1</td><td>–</td><td>–</td><td>–</td><td>–</td><td>–</td></tr>
            <tr><td>R1–R2</td><td>–</td><td>–</td><td>–</td><td>–</td><td>–</td></tr>
            <tr><td>R2–R3</td><td>–</td><td>–</td><td>–</td><td>–</td><td>–</td></tr>
            <tr><td>&gt;R3</td><td>–</td><td>–</td><td>–</td><td>–</td><td>–</td></tr>
            <tr><td><b>Total</b></td><td>–</td><td></td><td></td><td></td><td>–</td></tr>
          </tbody>
        </table>
        <div class="row"><button id="exportCostBtn" class="btn">Export cost summary (CSV)</button></div>
      </div>
    </div>

    <!-- NEW: HQ -> Ports export leg -->
    <div class="row">
      <div class="card" style="width:100%">
        <b>HQ → Ports (export leg)</b>
        <div class="row" style="margin-top:6px">
          <label>
            Payload per truck (t)
            <input id="payloadT" class="input" type="number" step="1" value="24" style="width:90px">
          </label>
          <label>
            <input type="checkbox" id="assumeBackhaul" checked>
            Assume backhaul (loaded both ways)
          </label>
          <label>
            <input type="checkbox" id="includePerStopPort" checked>
            Include per-stop cost
          </label>
          <button id="updatePortsBtn" class="btn">Update ports</button>
          <button id="exportPortsBtn" class="btn">Export ports (CSV)</button>
        </div>

        <table class="summary" id="portsTable" style="margin-top:6px">
          <thead>
            <tr>
              <th>Port</th>
              <th>Distance HQ–port (km)</th>
              <th>€/trip (return)</th>
              <th>€/t (one way)</th>
            </tr>
          </thead>
          <tbody id="portsTableBody"></tbody>
        </table>

        <div class="small" style="margin-top:6px">
          €/trip (return) uses 2×distance and current Fuel + Fixed €/km.
          €/t (one way) divides by payload (or 2×payload if backhaul is ticked).
        </div>
      </div>
    </div>

 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const DEFAULT_HQ = [53.70370155119458, -6.3673405707579525];
const PORTS = [
  { name: "Drogheda Port", lat: 53.7144, lon: -6.3185 },
  { name: "Greenore Port", lat: 54.0315, lon: -6.1314 },
  { name: "Dundalk Port",  lat: 54.0109, lon: -6.3995 },
  { name: "Dublin Port",   lat: 53.3509, lon: -6.2109 },
  { name: "New Ross Port",              lat: 52.3962044, lon: -6.94719 },
  { name: "Wexford Port (Wexford Quay)",lat: 52.3389979, lon: -6.458228 },
  { name: "Port of Waterford (Belview)",lat: 52.2641,    lon: -7.0368 },
];

// Panel toggle
const panelBody = document.getElementById('panelBody');
const togglePanelBtn = document.getElementById('togglePanelBtn');
let panelOpen = true;
togglePanelBtn.addEventListener('click', function() {
  panelOpen = !panelOpen;
  panelBody.style.display = panelOpen ? 'block' : 'none';
  togglePanelBtn.textContent = panelOpen ? 'Hide panel ▲' : 'Show panel ▼';
  togglePanelBtn.setAttribute('aria-expanded', panelOpen ? 'true' : 'false');
});

// Map
const map = L.map('map').setView([53.4, -8.2], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
   
<script>
const DEFAULT_HQ = [53.70370155119458, -6.3673405707579525];
const PORTS = [
  { name: "Drogheda Port", lat: 53.7144, lon: -6.3185 },
  { name: "Greenore Port", lat: 54.0315, lon: -6.1314 },
  { name: "Dundalk Port",  lat: 54.0109, lon: -6.3995 },
  { name: "Dublin Port",   lat: 53.3509, lon: -6.2109 },
  { name: "New Ross Port",              lat: 52.3962044, lon: -6.94719 },
  { name: "Wexford Port (Wexford Quay)",lat: 52.3389979, lon: -6.458228 },
  { name: "Port of Waterford (Belview)",lat: 52.2641,    lon: -7.0368 },
];

// Panel toggle
const panelBody = document.getElementById('panelBody');
const togglePanelBtn = document.getElementById('togglePanelBtn');
let panelOpen = true;
togglePanelBtn.addEventListener('click', function() {
  panelOpen = !panelOpen;
  panelBody.style.display = panelOpen ? 'block' : 'none';
  togglePanelBtn.textContent = panelOpen ? 'Hide panel ▲' : 'Show panel ▼';
  togglePanelBtn.setAttribute('aria-expanded', panelOpen ? 'true' : 'false');
});

// Map
const map = L.map('map').setView([53.4, -8.2], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

function toRad(d){return d*Math.PI/180}
function haversineKm(a,b){
  if(!a||!b) return null;
  const R=6371, dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]), lat1=toRad(a[0]), lat2=toRad(b[0]);
  const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
function mCircle(lat,lon,color,r){ return L.circleMarker([lat,lon],{radius:r,color:color,fillColor:color,fillOpacity:.9,weight:1}); }
function download(filename,text,type='text/plain'){ const blob=new Blob([text],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove(); }
function mean(xs){ const a=xs.filter(v=>typeof v==='number'&&!isNaN(v)); if(!a.length) return null; return a.reduce((x,y)=>x+y,0)/a.length; }

// HQ
let HQ = DEFAULT_HQ.slice();
const HQ_ICON = L.circleMarker(HQ,{radius:9,color:'#d32f2f',fillColor:'#d32f2f',fillOpacity:.95,weight:2}).addTo(map);
const hqBadge = document.getElementById('hqBadge');
const hqAddress = document.getElementById('hqAddress');
function setHQ(lat,lon){ HQ=[lat,lon]; HQ_ICON.setLatLng(HQ).bindPopup('<b>Circtec HQ</b>').openPopup(); hqBadge.textContent='HQ ✓ ('+lat.toFixed(5)+', '+lon.toFixed(5)+')'; computeDistances(); render(); refreshRings(); updateCostSummary(); }
document.getElementById('setHqBtn').addEventListener('click', function(){ const lat=parseFloat(document.getElementById('hqLat').value); const lon=parseFloat(document.getElementById('hqLon').value); if(isNaN(lat)||isNaN(lon)) return; setHQ(lat,lon); });
document.getElementById('clickHqBtn').addEventListener('click', function(){ hqBadge.textContent='Click the map to set HQ…'; const once=function(e){ setHQ(e.latlng.lat,e.latlng.lng); map.off('click',once); }; map.on('click', once); });
document.getElementById('geocodeHqBtn').addEventListener('click', async function(){ hqBadge.textContent='Geocoding…'; const url='https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(hqAddress.value+', Ireland')+'&limit=1&addressdetails=0'; try{ const resp=await fetch(url,{headers:{'Accept-Language':'en'}}); const data=await resp.json(); if(data&&data.length){ setHQ(parseFloat(data[0].lat), parseFloat(data[0].lon)); } else { hqBadge.textContent='HQ not found'; } }catch(e){ hqBadge.textContent='HQ error'; } });

// Rings
const ringsGroup = L.layerGroup().addTo(map);
function getRings(){ const r1=parseFloat(document.getElementById('ring1km').value)||50; const r2=parseFloat(document.getElementById('ring2km').value)||100; const r3=parseFloat(document.getElementById('ring3km').value)||150; return [r1,r2,r3].sort((a,b)=>a-b); }
function refreshRings(){ ringsGroup.clearLayers(); if(!document.getElementById('toggleRings').checked||!HQ) return; const [r1,r2,r3]=getRings(); [r1,r2,r3].forEach(function(km){ const c=L.circle(HQ,{radius:km*1000,color:'#1976d2',weight:1.5,fillOpacity:0.03}); ringsGroup.addLayer(c); }); }
document.getElementById('applyRingsBtn').addEventListener('click', function(){ refreshRings(); updateCostSummary(); });
document.getElementById('toggleRings').addEventListener('change', refreshRings);
document.getElementById('zoomRingsBtn').addEventListener('click', function(){ if(!HQ) return; const r=getRings(); const outer=L.circle(HQ,{radius:r[2]*1000}); map.fitBounds(outer.getBounds(),{padding:[20,20]}); });

// Data layers
const heat = L.heatLayer([], {radius:20, blur:25, maxZoom:11});
const markers = L.markerClusterGroup();
let current = GARAGES.slice();
  function hasCoords(r) {
  return r &&
    typeof r.lat === 'number' && !isNaN(r.lat) &&
    typeof r.lon === 'number' && !isNaN(r.lon);
}

function render() {
  // Only garages with usable coordinates
  const pts = current.filter(hasCoords);

  // Heat map layer
  heat.setLatLngs(
    pts.map(function (r) { return [r.lat, r.lon]; })
  );

  // Marker clusters
  markers.clearLayers();
  pts.forEach(function (r) {
    const name = r.trading_as || r.registered_name || '';
    const addr = r.full_address || '';
    const county = r.county || '';
    const distText =
      (r.distance_km != null && !isNaN(r.distance_km))
        ? ('<br/><b>' + r.distance_km.toFixed(2) + ' km from HQ</b>')
        : '';

    const html =
      '<div style="min-width:220px">' +
        '<b>' + name + '</b>' +
        '<br/>' + addr +
        (county ? '<br/><small>' + county + '</small>' : '') +
        distText +
      '</div>';

    const m = mCircle(r.lat, r.lon, '#2e7d32', 6).bindPopup(html);
    markers.addLayer(m);
  });

  // Count of garages in the current filter (not just plottable ones)
  document.getElementById('count').textContent = current.length;
}

document.querySelectorAll('input[name="view"]').forEach(function(el){ el.addEventListener('change', function(e){ if(e.target.value==='heat'){ map.addLayer(heat); if(map.hasLayer(markers)) map.removeLayer(markers); } else { if(map.hasLayer(heat)) map.removeLayer(heat); map.addLayer(markers); } }); });
map.addLayer(heat);

// Filters
const countySel=document.getElementById('countyFilter');
Array.from(new Set(GARAGES.map(r=>r.county).filter(Boolean))).sort().forEach(function(c){ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; countySel.appendChild(opt); });
function applyFilters(){ const c=countySel.value.trim().toLowerCase(); const q=(document.getElementById('searchBox').value||'').trim().toLowerCase(); const maxKm=parseFloat(document.getElementById('withinKm').value); current=GARAGES.filter(function(r){ const countyOk=!c||((r.county||'').toLowerCase()===c); if(!countyOk) return false; const hay=((r.registered_name||'')+' '+(r.trading_as||'')+' '+(r.full_address||'')).toLowerCase(); const textOk=!q||hay.includes(q); if(!textOk) return false; if(!isNaN(maxKm)&&HQ){ if(r.distance_km==null||isNaN(r.distance_km)) return false; if(r.distance_km>maxKm) return false; } return true; }); render(); updateCostSummary(); }
countySel.addEventListener('change', applyFilters);
document.getElementById('searchBox').addEventListener('input', applyFilters);
document.getElementById('withinKm').addEventListener('input', applyFilters);
document.getElementById('clearFilters').addEventListener('click', function(){ countySel.value=''; document.getElementById('searchBox').value=''; document.getElementById('withinKm').value=''; current=GARAGES.slice(); render(); updateCostSummary(); });

// Distances
function computeDistances() {
  if (!HQ) return;
  GARAGES.forEach(function (r) {
    if (!hasCoords(r)) {
      // no valid lat/lon → no distance, and it must NOT go into any band
      r.distance_km = NaN;
      return;
    }
    const d = haversineKm(HQ, [r.lat, r.lon]);
    r.distance_km = (d == null || isNaN(d)) ? NaN : d;
  });
}

// Collectors
const collectorsGroup = L.layerGroup().addTo(map);
function renderCollectors(){ collectorsGroup.clearLayers(); COLLECTORS.forEach(function(p){ if(p.lat!=null && p.lon!=null){ const m=mCircle(p.lat,p.lon,'#ff6d00',6).bindPopup('<div><b>'+(p.name||'Collector')+'</b><br/>'+(p.address||'')+'</div>'); collectorsGroup.addLayer(m); } }); }

// Cost model
function getCI(){ const fuel=parseFloat(document.getElementById('fuelPerKm').value)||0; const fixed=parseFloat(document.getElementById('fixedPerKm').value)||0; const perStop=parseFloat(document.getElementById('perStop').value)||0; const pickups=parseFloat(document.getElementById('pickupsPerYear').value)||1; return {fuel,fixed,perStop,pickups,totalPerKm:(fuel+fixed)}; }
function bands() {
  const r = getRings();             // [R1, R2, R3]
  const b = [[], [], [], []];       // 0–R1, R1–R2, R2–R3, >R3

  current.forEach(function (g) {
    const d = g.distance_km;
    if (d == null || isNaN(d)) return;   // skip anything without a real distance

    if (d <= r[0])      b[0].push(d);
    else if (d <= r[1]) b[1].push(d);
    else if (d <= r[2]) b[2].push(d);
    else                b[3].push(d);
  });

  return { r, b };
}

function calcTrip(dist,ci){ return ci.perStop + 2*dist*ci.totalPerKm; }
function updateCostSummary() {
  const ci = getCI();
  const { r, b } = bands();
  const tbody = document.querySelector('#costTable tbody');
  const rows = tbody.querySelectorAll('tr');

  // average distance estimates for each band
  const avgs = [
    (mean(b[0]) ?? 0.67 * r[0]),
    (mean(b[1]) ?? 0.5 * (r[0] + r[1])),
    (mean(b[2]) ?? 0.5 * (r[1] + r[2])),
    (mean(b[3]) ?? 1.33 * r[2])
  ];

  let totalSites = 0;
  let totalYear = 0;

  // payload (t) used for €/t column
  const payload = parseFloat(document.getElementById('payloadT')?.value) || 24;

  for (let i = 0; i < 4; i++) {
    const sites = b[i].length;
    totalSites += sites;

    const dist = avgs[i];
    const perTrip = calcTrip(dist, ci);               // €/trip/site (return)
    const perYear = perTrip * ci.pickups * sites;     // €/year for that band
    const euroPerT = payload > 0 ? (perTrip / payload) : 0;  // €/t (one way)

    const tds = rows[i].querySelectorAll('td');
    tds[1].textContent = sites;
    tds[2].textContent = dist.toFixed(1);
    tds[3].textContent = '€' + perTrip.toFixed(2);
    tds[4].textContent = '€' + euroPerT.toFixed(2);
    tds[5].textContent = '€' + perYear.toLocaleString(
      undefined,
      { minimumFractionDigits: 2, maximumFractionDigits: 2 }
    );

    totalYear += perYear;
  }

  const totalRowCells = rows[4].querySelectorAll('td');
  totalRowCells[1].textContent = totalSites;
  totalRowCells[5].textContent = '€' + totalYear.toLocaleString(
    undefined,
    { minimumFractionDigits: 2, maximumFractionDigits: 2 }
  );
}
function updatePortsTable(){
  const tbody = document.getElementById('portsTableBody');
  if (!tbody || !HQ) return;

  const ci = getCI();
  const payload = parseFloat(document.getElementById('payloadT').value) || 24;
  const backhaul = document.getElementById('assumeBackhaul').checked;
  const includePerStop = document.getElementById('includePerStopPort').checked;

  tbody.innerHTML = '';

  PORTS.forEach(function(p){
    const dist = haversineKm(HQ, [p.lat, p.lon]);
    if (dist == null || isNaN(dist)) return;

    // €/trip (return): 2 × distance × (Fuel + Fixed) + optional per-stop
    let trip = 2 * dist * ci.totalPerKm;
    if (includePerStop) trip += ci.perStop;

    // €/t (one way). If backhaul, assume 2×payload tonnes moved.
    const denom = backhaul ? 2 * payload : payload;
    const euroPerT = denom > 0 ? (trip / denom) : NaN;

    const tr = document.createElement('tr');
    function addCell(val){
      const td = document.createElement('td');
      td.textContent = val;
      tr.appendChild(td);
    }
    addCell(p.name);
    addCell(dist.toFixed(1));
    addCell('€' + trip.toFixed(2));
    addCell(isNaN(euroPerT) ? '—' : '€' + euroPerT.toFixed(2));

    tbody.appendChild(tr);
  });
}

// button in the panel
document.getElementById('updatePortsBtn').addEventListener('click', updatePortsTable);

// Exports (garages CSV)
document.getElementById('exportCsvBtn').addEventListener('click', function(){
  const headers = ["Registered Name","Trading As","FullAddress","County","lat","lon","distance_km"];
  const out = [headers.join(',')];
  current.forEach(function(r){
    const vals = [
      r.registered_name,
      r.trading_as,
      r.full_address,
      r.county,
      r.lat,
      r.lon,
      (isNaN(r.distance_km) ? '' : r.distance_km.toFixed(2))
    ].map(v => (v == null ? "" : (""+v).replace(/"/g,'""')));
    out.push('"'+vals.join('","')+'"');
  });
  // plain CSV is fine here; Numbers handles it well
  download('garages_filtered.csv', out.join('\n'), 'text/csv');
});

// Export Collection Cost Summary (includes €/t, formatted to 2 decimals)
document.getElementById('exportCostBtn').addEventListener('click', function(){
  const rows = document.querySelectorAll('#costTable tr');
  let csv = '';

  // Header title
  csv += 'Collection Cost Summary (€/trip, €/t, €/year)\n';

  rows.forEach(r => {
    const cols = r.querySelectorAll('th,td');
    const vals = [...cols].map(c => {
      let v = c.textContent.trim();

      // normalise euro values to two decimals if numeric and starting with €
      if (v.startsWith('€')) {
        const num = parseFloat(v.replace('€','').replace(/,/g,''));
        if (!isNaN(num)) return '€' + num.toFixed(2);
      }
      return v;
    });

    csv += vals.join(',') + '\n';
  });

  // Payload line
  const payload = parseFloat(document.getElementById('payloadT')?.value) || 24;
  csv += `\nAssumed payload (t),${payload}\n`;

  // BOM so Excel/Numbers detect UTF-8 nicely
  const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'collection_cost_summary.csv';
  a.click();
});

// Export Ports (HQ → Ports) table to CSV (Excel-friendly)
document.getElementById('exportPortsBtn').addEventListener('click', function () {
  if (!HQ) return;

  const ci = getCI();
  const payload = parseFloat(document.getElementById('payloadT')?.value) || 24;
  const backhaul = !!document.getElementById('assumeBackhaul')?.checked;
  const includePerStop = !!document.getElementById('includePerStopPort')?.checked;

  // Header lines with current assumptions
  const title = 'Ports Cost Summary (HQ → Ports)';
  const assumptions = [
    ['Fuel €/km', ci.fuel.toFixed(2)],
    ['Fixed €/km', ci.fixed.toFixed(2)],
    ['Per-stop €/pickup', ci.perStop.toFixed(2)],
    ['Payload (t)', payload],
    ['Assume backhaul', backhaul ? 'Yes' : 'No'],
    ['Include per-stop', includePerStop ? 'Yes' : 'No']
  ];

  // Table header
  const header = ['Port', 'Distance HQ–port (km)', '€/trip (return)', '€/t (one way)'];

  // Compute rows using same formulas as updatePortsTable()
  const rows = PORTS.map(p => {
    const dist = haversineKm(HQ, [p.lat, p.lon]) || 0;
    const base = 2 * dist * ci.totalPerKm;
    const trip = base + (includePerStop ? ci.perStop : 0);
    const denom = backhaul ? (2 * payload) : payload;
    const euroPerT = denom > 0 ? (trip / denom) : NaN;
    return [
      p.name,
      dist.toFixed(1),
      '€' + trip.toFixed(2),
      isNaN(euroPerT) ? '—' : '€' + euroPerT.toFixed(2)
    ];
  });

  // Build CSV (with UTF-8 BOM so Excel/Numbers open it cleanly)
  let csv = '';
  csv += title + '\n';
  assumptions.forEach(pair => { csv += pair[0] + ',' + pair[1] + '\n'; });
  csv += '\n' + header.join(',') + '\n';
  rows.forEach(r => { csv += r.join(',') + '\n'; });

  const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ports_cost_summary.csv';
  a.click();
});

function init(){ 
  computeDistances();
  map.addLayer(heat);
  render();
  refreshRings();
  updateCostSummary();
  updatePortsTable();  // fill ports table on load
  document.getElementById('hqBadge').textContent =
    'HQ ✓ ('+DEFAULT_HQ[0].toFixed(5)+', '+DEFAULT_HQ[1].toFixed(5)+')';
}
init();
</script>
</body>
</html>
